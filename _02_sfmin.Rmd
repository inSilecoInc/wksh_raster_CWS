---
title: "intro to sf"
---

```{r include = FALSE}
source("_setup.R")
library(sf)
library(tidyverse)
```

---

class: inverse, center, middle

# `r nf()` Introduction to `sf`

![:custom_hr]()

## `r ck()` ~20min


???

If after the workshop what follows makes sense and you feel it is kind of true, it would a success.

---

# Introduction to `sf`

## What is `sf`

Intro to package, vector objects


---

# Introduction to `sf`

## `sf` objects

.pull-left[
- Most common geometries:
  - `POINT`
  - `MULTIPOINT`
  - `LINESTRING`
  - `MULTILINESTRING`
  - `POLYGON`
  - `MULTIPOLYGON`
  - `GEOMETRYCOLLECTION`
]

.pull-right[
![](https://r-spatial.github.io/sf/articles/sf1_files/figure-html/unnamed-chunk-20-1.png)
]


---

# Introduction to `sf`

## `sf` objects

![](https://r-spatial.github.io/sf/articles/sf_xfig.png)

---

# Introduction to `sf`

## Importing: from `.csv`

Acess the [Computerized Database of Qu√©bec Seabirds (CDQS)](https://open.canada.ca/data/en/dataset/9cd6f8a1-e660-4e78-89a8-6e3f781da556) data using the [`rgovcan`](https://github.com/VLucet/rgovcan) package.

```{r csv}
# Output folder
dir.create('output')

# remotes::install_github("vlucet/rgovcan")
library(rgovcan)
id <- "9cd6f8a1-e660-4e78-89a8-6e3f781da556"
govcan_dl_resources(id, path = 'output')

# Import csv
cdqs <- read.csv('output/CDQS_BIOMQ_2017.csv')
```


---

# Introduction to `sf`

## Importing: from `.csv`

```{r csvsf}
cdqs <- st_as_sf(x = cdqs,
                 coords = c("CentroideX", "CentroideY"),
                 crs = 4326)
```

.font80[
```{r showcsvsf, echo = FALSE}
cdqs[,1]
```
]

---

# Introduction to `sf`

## Importing: from `.csv`

```{r csvplot}
plot(st_geometry(cdqs))
```


---


# Introduction to `sf`

## Importing: from `.shp`

[Roseate Tern critical habitats in Atlantic Canada](https://open.canada.ca/data/en/dataset/0c469c0e-8afd-4c62-9420-c50af2d34f97)

```{r shp, messages = FALSE, warnings = FALSE}
id <- "0c469c0e-8afd-4c62-9420-c50af2d34f97"
govcan_dl_resources(id, path = 'output')
unzip("output/Sterna_dougallii_Roseate_Tern_CH_2015.zip", exdir = 'output')

# Import shapefile
roseate <- st_read("output/Sterna_dougallii_Roseate_Tern_CH_2015.shp", quiet = TRUE)
```

---


# Introduction to `sf`

## Importing: from `.shp`

[Roseate Tern critical habitats in Atlantic Canada](https://open.canada.ca/data/en/dataset/0c469c0e-8afd-4c62-9420-c50af2d34f97)

.font80[
```{r showshp, echo = FALSE}
roseate
```
]

---


# Introduction to `sf`

## Importing: from `.shp`

[Roseate Tern critical habitats in Atlantic Canada](https://open.canada.ca/data/en/dataset/0c469c0e-8afd-4c62-9420-c50af2d34f97)

.font80[
```{r shpplot}
plot(st_geometry(roseate[4,]))
```
]

---

# Introduction to `sf`

## Importing: from `.geojson`

We already have a geojson included in the workshop data: `st_laurence.geojson`

```{r geojson, hold = TRUE}
stl <- st_read('data/st_laurence.geojson', quiet = TRUE)
stl
```

`r tr()` We strongly suggest using geojson (single file) rather than shapefiles (multiple files)

---

# Introduction to `sf`

## Importing: from `.geojson`

We already have a geojson included in the workshop data: `st_laurence.geojson`

```{r geojsonplot, eval = FALSE}
plot(st_geometry(stl))
```


---

# Introduction to `sf`

## Importing: from `.gbd`

[Atlas of Seabirds at Sea in Eastern Canada 2006-2016](https://open.canada.ca/data/en/dataset/f612e2b4-5c67-46dc-9a84-1154c649ab4e)

```{r gbd, messages = FALSE, warnings = FALSE}
id <- "f612e2b4-5c67-46dc-9a84-1154c649ab4e"
govcan_dl_resources(id, path = 'output')
unzip("output/AtlasGrid-GrilleAtlas.gdb.zip", exdir = 'output')
```

---

# Introduction to `sf`

## Importing: from `.gbd`

[Atlas of Seabirds at Sea in Eastern Canada 2006-2016](https://open.canada.ca/data/en/dataset/f612e2b4-5c67-46dc-9a84-1154c649ab4e)

```{r gbdlayer, messages = FALSE, warnings = FALSE}
# Visualize layers available in the geodatabase
st_layers("output/AtlasGrid-GrilleAtlas.gdb")

# Load layer
atlas <- st_read('output/AtlasGrid-GrilleAtlas.gdb',
                  layer = 'AtlasGrid_GrilleAtlas')
```

---

# Introduction to `sf`

## Importing: from `.gbd`

[Atlas of Seabirds at Sea in Eastern Canada 2006-2016](https://open.canada.ca/data/en/dataset/f612e2b4-5c67-46dc-9a84-1154c649ab4e)

```{r gbdplot, messages = FALSE, warnings = FALSE}
plot(st_geometry(atlas))
```

---

# Introduction to `sf`

## Exporting

```{r export}
st_write(roseate, "output/roseate.shp", delete_dsn = TRUE)
st_write(stl, "output/stl.geojson", delete_dsn = TRUE)
```

---

# Introduction to `sf`

## Exporting

```{r echo = FALSE}
oldopt <- options()$width
options(width=150)
```

.font60[
```{r drivers}

st_drivers()
```
]

```{r echo = FALSE}
options(width=oldopt)
```


---

# Introduction to `sf`

## Transform between `sf` and `sp`


`r tr()` You can use `st_as_sf()` to transform `sp` object to `sf` objects...

.font80[
```{r sp, eval = FALSE}
# Do not run
newsf <- st_as_sf(oldsp)
```
]

... and vice-versa with `as()`

.font80[
```{r spsf, eval = FALSE}
# Do not run
newsp <- as(oldsf, "Spatial")
```
]


---

# Introduction to `sf`

## Spatial projections

`r tr()` Covered in `stars` portion of the workshop


---

# introduction to `sf`

## Manipulating attributes

- The `sf` package is built to work well with the `tidyverse`
- As such, you can essentially treat an `sf` object as you would a `data.frame`


---

# introduction to `sf`

## Manipulating attributes: new variable


```{r attr_hist, fig.width=6,fig.height=4}
hist(cdqs$Nombre.de.nicheurs.Number.of.Breeders)
```

---

# introduction to `sf`

## Manipulating attributes: new variable

```{r attr_add, fig.width=6,fig.height=4}
cdqs$var2 <- log(cdqs$Nombre.de.nicheurs.Number.of.Breeders+1)
hist(cdqs$var2)
```

---

# introduction to `sf`

## Manipulating attributes: new variable

```{r attr_add2, fig.width=6,fig.height=4}
cdqs <- cdqs %>% mutate(var3 = log(Nombre.de.nicheurs.Number.of.Breeders+1))
hist(cdqs$var3)
```

---

# introduction to `sf`

## Manipulating attributes: remove variable

```{r attr_rem, fig.width=6,fig.height=4}
cdqs$var2 <- NULL
cdqs <- cdqs %>% select(-var3)
colnames(cdqs)
```


---

# introduction to `sf`

## Manipulating attributes: subsets

- Working with conditional statements (use `filter()` from the tidyverse)

```{r attr_sub, fig.width=6,fig.height=3.5}
newcdqs <- cdqs[cdqs$Annee.Year > 2000, ]
plot(st_geometry(cdqs), pch = 1, col = '#2ae9ee', cex = 1)
plot(st_geometry(newcdqs), pch = 20, col = '#d76060', cex = .8, add = TRUE)
```

---

# introduction to `sf`

## Manipulating attributes: joins

```{r attr_join, fig.width=6,fig.height=3.5}
atlas
```


---

# introduction to `sf`

## Manipulating attributes: joins

```{r attr_join2, fig.width=6,fig.height=3.5}
join_data <- data.frame(id = paste0('g', sample(nrow(atlas), nrow(atlas))),
                        value = runif(nrow(atlas)))
join_data[1:10, ]
```

---

# introduction to `sf`

## Manipulating attributes: joins

```{r attr_join3, fig.width=6,fig.height=3.5}
newatlas <- left_join(atlas, join_data, by='id')
```

.pull-left[
.font80[
```{r, echo = FALSE}
newatlas[1:10,c('id','value','Shape'), drop = TRUE]
```
]
]

.pull-right[
```{r, echo = FALSE, fig.width=4, fig.height=3.5}
plot(newatlas[,'value'])
```
]

---

# introduction to `sf`

## Geometry manipulations: union (a.k.a. dissolve)

```{r union, fig.width = 6, fig.height=4}
newatlas <- st_union(atlas)
plot(newatlas)
```


---

# introduction to `sf`

## Geometry manipulations: buffer (units = projection)

.pull-left[
```{r buffer1, fig.width = 4, fig.height=4}
newatlas <- st_buffer(atlas, 10000)
plot(st_geometry(newatlas))
```
]

.pull-left[
```{r buffer2, fig.width = 4, fig.height=4}
newatlas <- st_buffer(atlas, -10000)
plot(st_geometry(newatlas))
```
]


- intersect
- buffer
- difference
- area / distance



---

# introduction to `sf`

## Geometry manipulations

R Studio [Cheat sheets](https://github.com/rstudio/cheatsheets/blob/master/sf.pdf) for `sf`

.pull-left[
  <center><img src="img/sf1.png" width="100%"></img></center>
]

.pull-right[
  <center><img src="img/sf2.png" width="100%"></img></center>
]

- This [vignette](https://cran.r-project.org/web/packages/sf/vignettes/sf3.html) for an overview of geometry manipulations using `sf`








---

# Introduction to `sf`

## Create a `sf` object

.pull-left[
```{r mydata}
# Dummy data
mylon <- -82+2*runif(20)
mylat <- 42+2*runif(20)
mydata <- data.frame(
  lon = mylon,
  lat = mylat,
  var1 = rnorm(20),
  var2 = 10*runif(20))
```
]

.pull-right[
.font80[
```{r showmydata, echo = FALSE}
mydata[1:10, ]
```
]
]

`r tr()` Does this look familiar? You probably often deal with this type of data in the form of a `.csv` file with coordinates and attributes.

---

# Introduction to `sf`

## Create a `sf` object

.pull-left[
```{r createsf}
library(sf)
pts_sf <- st_as_sf(x = mydata,
                   coords = c("lon", "lat"),
                   crs = 4326)
```

.font80[
```{r showsf, echo = FALSE}
pts_sf
```
]
]



---



This section should cover sf

* what is it
* understand the object
* how to manipulate sf attribute tabkle with tidyverse
* how to do basic spatial manipulations
  * intersect /union / difference
  * projection
  * areas
